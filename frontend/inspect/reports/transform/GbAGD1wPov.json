{"resolvedId":"/home/edge/dev/js/private-cloud/src/routes/login.tsx?data","transforms":[{"name":"__load__","result":"import { Show } from \"solid-js\";\nimport { useParams, useRouteData } from \"solid-start\";\nimport { FormError } from \"solid-start/data\";\nimport {\n  createServerAction$,\n  createServerData$,\n  redirect,\n} from \"solid-start/server\";\nimport { db } from \"~/db\";\nimport { createUserSession, getUser, login, register } from \"~/db/session\";\n\nfunction validateUsername(username: unknown) {\n  if (typeof username !== \"string\" || username.length < 4) {\n    return `Usernames must be at least 4 characters long`;\n  }\n}\n\nfunction validatePassword(password: unknown) {\n  if (typeof password !== \"string\" || password.length < 10) {\n    return `Passwords must be at least 10 characters long`;\n  }\n}\n\nexport function routeData() {\n  return createServerData$(async (_, { request }) => {\n    if (await getUser(request)) {\n      throw redirect(\"/\");\n    }\n    return {};\n  });\n}\n\nexport default function Login() {\n  const data = useRouteData<typeof routeData>();\n  const params = useParams();\n\n  const [loggingIn, { Form }] = createServerAction$(async (form: FormData) => {\n    const loginType = form.get(\"loginType\");\n    const username = form.get(\"username\");\n    const password = form.get(\"password\");\n    const redirectTo = form.get(\"redirectTo\") || \"/\";\n    if (\n      typeof loginType !== \"string\" ||\n      typeof username !== \"string\" ||\n      typeof password !== \"string\" ||\n      typeof redirectTo !== \"string\"\n    ) {\n      throw new FormError(`Form not submitted correctly.`);\n    }\n\n    const fields = { loginType, username, password };\n    const fieldErrors = {\n      username: validateUsername(username),\n      password: validatePassword(password),\n    };\n    if (Object.values(fieldErrors).some(Boolean)) {\n      throw new FormError(\"Fields invalid\", { fieldErrors, fields });\n    }\n\n    switch (loginType) {\n      case \"login\": {\n        const user = await login({ username, password });\n        if (!user) {\n          throw new FormError(`Username/Password combination is incorrect`, {\n            fields,\n          });\n        }\n        return createUserSession(`${user.id}`, redirectTo);\n      }\n      case \"register\": {\n        const userExists = await db.user.findUnique({ where: { username } });\n        if (userExists) {\n          throw new FormError(`User with username ${username} already exists`, {\n            fields,\n          });\n        }\n        const user = await register({ username, password });\n        if (!user) {\n          throw new FormError(\n            `Something went wrong trying to create a new user.`,\n            {\n              fields,\n            }\n          );\n        }\n        return createUserSession(`${user.id}`, redirectTo);\n      }\n      default: {\n        throw new FormError(`Login type invalid`, { fields });\n      }\n    }\n  });\n\n  return (\n    <main>\n      <h1>Login</h1>\n      <Form>\n        <input\n          type=\"hidden\"\n          name=\"redirectTo\"\n          value={params.redirectTo ?? \"/\"}\n        />\n        <fieldset>\n          <legend>Login or Register?</legend>\n          <label class=\"text-red-500\">\n            <input class=\"text-red-500\" type=\"radio\" name=\"loginType\" value=\"login\" checked={true} />{\" \"}\n            Login\n          </label>\n          <label>\n            <input type=\"radio\" name=\"loginType\" value=\"register\" /> Register\n          </label>\n        </fieldset>\n        <div>\n          <label for=\"username-input\">Username</label>\n          <input name=\"username\" placeholder=\"kody\" />\n        </div>\n        <Show when={loggingIn.error?.fieldErrors?.username}>\n          <p role=\"alert\">{loggingIn.error.fieldErrors.username}</p>\n        </Show>\n        <div>\n          <label for=\"password-input\">Password</label>\n          <input name=\"password\" type=\"password\" placeholder=\"twixrox\" />\n        </div>\n        <Show when={loggingIn.error?.fieldErrors?.password}>\n          <p role=\"alert\">{loggingIn.error.fieldErrors.password}</p>\n        </Show>\n        <Show when={loggingIn.error}>\n          <p role=\"alert\" id=\"error-message\">\n            {loggingIn.error.message}\n          </p>\n        </Show>\n        <button type=\"submit\">{data() ? \"Login\" : \"\"}</button>\n      </Form>\n    </main>\n  );\n}\n","start":1675681823105,"end":1675681823105},{"name":"solid-start-file-system-router","result":"import { createRouteData } from \"solid-start/data\";\nimport server$ from \"solid-start/server\";\nconst $$server_module0 = server$.createFetcher(\"/_m/src/routes/login.tsx/0/routeData\", true);\nexport function routeData() {\n  return createRouteData($$server_module0);\n}\nexport const _modHash = \"IYxoWO3Cp+DOxSbo1Cc7RtcN0Xv35XpMLJpJDro85q4=\";\nif (import.meta.hot) {\n  import.meta.hot.data.modHash = _modHash;\n  import.meta.hot.accept(newMod => {\n    import.meta.hot.data.modHash = _modHash;\n    if (import.meta.hot.data.modHash !== newMod._modHash) {\n      import.meta.hot.invalidate();\n    }\n  });\n}","start":1675681823105,"end":1675681823123,"order":"pre"},{"name":"solid","result":"import { shouldWarnAndDecline as _shouldWarnAndDecline } from \"solid-refresh\";\nimport { createRouteData } from \"solid-start/data\";\nimport server$ from \"solid-start/server\";\nconst $$server_module0 = server$.createFetcher(\"/_m/src/routes/login.tsx/0/routeData\", true);\nexport function routeData() {\n  return createRouteData($$server_module0);\n}\nexport const _modHash = \"IYxoWO3Cp+DOxSbo1Cc7RtcN0Xv35XpMLJpJDro85q4=\";\nif (import.meta.hot) {\n  import.meta.hot.data.modHash = _modHash;\n  import.meta.hot.accept(newMod => {\n    import.meta.hot.data.modHash = _modHash;\n    if (import.meta.hot.data.modHash !== newMod._modHash) {\n      import.meta.hot.invalidate();\n    }\n  });\n}\nif (_shouldWarnAndDecline()) if (import.meta.hot) import.meta.hot.decline();","start":1675681823123,"end":1675681823131,"order":"pre"},{"name":"vite:import-analysis","result":"import { createHotContext as __vite__createHotContext } from \"/@vite/client\";import.meta.hot = __vite__createHotContext(\"/src/routes/login.tsx?data\");import { shouldWarnAndDecline as _shouldWarnAndDecline } from \"/@solid-refresh\";\nimport { createRouteData } from \"/node_modules/solid-start/data/index.ts?v=2963516b\";\nimport server$ from \"/node_modules/solid-start/server/browser.ts?v=2963516b\";\nconst $$server_module0 = server$.createFetcher(\"/_m/src/routes/login.tsx/0/routeData\", true);\nexport function routeData() {\n  return createRouteData($$server_module0);\n}\nexport const _modHash = \"IYxoWO3Cp+DOxSbo1Cc7RtcN0Xv35XpMLJpJDro85q4=\";\nif (import.meta.hot) {\n  import.meta.hot.data.modHash = _modHash;\n  import.meta.hot.accept(newMod => {\n    import.meta.hot.data.modHash = _modHash;\n    if (import.meta.hot.data.modHash !== newMod._modHash) {\n      import.meta.hot.invalidate();\n    }\n  });\n}\nif (_shouldWarnAndDecline()) if (import.meta.hot) import.meta.hot.decline();","start":1675681823131,"end":1675681823134,"order":"normal"}]}
